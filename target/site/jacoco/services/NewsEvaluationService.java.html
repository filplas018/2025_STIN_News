<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NewsEvaluationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">STIN_News</a> &gt; <a href="index.source.html" class="el_package">services</a> &gt; <span class="el_source">NewsEvaluationService.java</span></div><h1>NewsEvaluationService.java</h1><pre class="source lang-java linenums">package services;

import clients.AlphaVantageClient;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import dtos.StockQueryDto;
import lombok.RequiredArgsConstructor;
import models.StockSentiment;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import reactor.core.scheduler.Schedulers;
import repositories.StockSentimentRepository;

import java.io.IOException;
import java.time.*;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Service
@RequiredArgsConstructor
public class NewsEvaluationService {

<span class="fc" id="L30">    private static final Logger logger = LoggerFactory.getLogger(NewsEvaluationService.class);</span>
    private final AlphaVantageClient alphaVantageClient;



    @Autowired
    private SentimentAnalysisService sentimentAnalysisService;

    @Autowired
    private final StockSentimentRepository stockSentimentRepository;
    private final ObjectMapper objectMapper;

    @Value(&quot;${alpha_vantage.api.key}&quot;)
    private String apiKey;

    @Value(&quot;${sentiment.business-days-back}&quot;)
    private int BUSINESS_DAYS_BACK;

    @Value(&quot;${sentiment.news-min}&quot;)
    private int NEWS_MIN;

    @Value(&quot;${sentiment.news-max}&quot;)
    private int NEWS_MAX;



    /*     * Metoda pro vyhodnocení a uložení novinek pro akcie.
     *
     * @param stockQueryDtos Seznam dotazů na akcie.
     * @return Mono&lt;Void&gt; indikující dokončení operace.
     */
    public Mono&lt;Void&gt; evaluateAndStoreNews(List&lt;StockQueryDto&gt; stockQueryDtos) {
<span class="fc" id="L62">        DateTimeFormatter alphaVantageFormatter = DateTimeFormatter.ofPattern(&quot;yyyyMMdd'T'HHmm&quot;);</span>
<span class="fc" id="L63">        ZoneId defaultZoneId = ZoneId.systemDefault();</span>
<span class="fc" id="L64">        logger.debug(&quot;Received stockQueryDtos: {}&quot;, stockQueryDtos);</span>

<span class="fc" id="L66">        return Flux.fromIterable(stockQueryDtos)</span>
<span class="fc" id="L67">                .flatMap(stockQueryDto -&gt; {</span>
                    try {
<span class="fc" id="L69">                        logger.debug(&quot;Processing stockQueryDto: {}&quot;, stockQueryDto);</span>
<span class="fc" id="L70">                        String ticker = stockQueryDto.getName();</span>
<span class="fc" id="L71">                        long toDateInMillis = stockQueryDto.getDate();</span>

<span class="fc" id="L73">                        LocalDate toLocalDate = Instant.ofEpochMilli(toDateInMillis)</span>
<span class="fc" id="L74">                                .atZone(defaultZoneId)</span>
<span class="fc" id="L75">                                .toLocalDate();</span>

<span class="fc" id="L77">                        LocalDate fromLocalDate = subtractBusinessDays(toLocalDate, BUSINESS_DAYS_BACK);</span>
<span class="fc" id="L78">                        LocalDateTime fromDateTime = fromLocalDate.atStartOfDay();</span>
<span class="fc" id="L79">                        LocalDateTime toDateTime = toLocalDate.atTime(23, 59, 59);</span>

                        // Používáme reaktivní přístup pro hledání existujícího sentimentu
<span class="fc" id="L82">                        return Mono.fromCallable(() -&gt;</span>
<span class="fc" id="L83">                                        stockSentimentRepository.findFirstByStockNameAndValidFromBetweenOrderByCreatedAtDesc(</span>
                                                ticker, fromDateTime, toDateTime
                                        ))
<span class="fc" id="L86">                                .flatMap(existingSentiment -&gt; {</span>

<span class="pc bpc" id="L88" title="1 of 2 branches missed.">                                    if (existingSentiment.isPresent()) {</span>
<span class="fc" id="L89">                                        logger.info(&quot;Záznam pro {} a datum {} již existuje. Přeskakuji stahování a uložení.&quot;, ticker, fromDateTime);</span>
<span class="fc" id="L90">                                        return Mono.empty(); // Záznam existuje, nic neděláme</span>
                                    } else {
                                        // Záznam neexistuje, stahujeme data z Alpha Vantage
<span class="nc" id="L93">                                        String fromDateFormatted = fromDateTime.format(alphaVantageFormatter);</span>
<span class="nc" id="L94">                                        String toDateFormatted = toDateTime.format(alphaVantageFormatter);</span>
<span class="nc" id="L95">                                        String sort = &quot;LATEST&quot;;</span>
<span class="nc" id="L96">                                        int limit = NEWS_MAX;</span>

<span class="nc" id="L98">                                        return alphaVantageClient.getCompanyNews(ticker, fromDateFormatted, toDateFormatted, sort, limit)</span>
<span class="nc" id="L99">                                                .flatMap(response -&gt; {</span>
                                                    try {
<span class="nc" id="L101">                                                        JsonNode root = objectMapper.readTree(response);</span>
<span class="nc" id="L102">                                                        JsonNode feedNode = root.path(&quot;feed&quot;);</span>

<span class="nc" id="L104">                                                        int numberOfNews = feedNode.size();</span>

<span class="nc bnc" id="L106" title="All 2 branches missed.">                                                        if (numberOfNews &lt; NEWS_MIN) {</span>
<span class="nc" id="L107">                                                            logger.warn(&quot;Not enough news for {}: found {} news items, minimum required is {}.&quot;, ticker, numberOfNews, NEWS_MIN);</span>
<span class="nc" id="L108">                                                            return Mono.empty(); // Neukládáme sentimenty</span>
                                                        }

                                                        // Používáme metodu pro zpracování sentimentu a uložení
<span class="nc" id="L112">                                                        return sentimentAnalysisService.processSentimentAndSave(ticker, feedNode, fromDateTime);</span>

<span class="nc" id="L114">                                                    } catch (IOException e) {</span>
<span class="nc" id="L115">                                                        logger.error(&quot;Error parsing news for {}: {}&quot;, ticker, e.getMessage(), e);</span>
<span class="nc" id="L116">                                                        return Mono.empty();</span>
                                                    }
                                                })
<span class="nc" id="L119">                                                .onErrorResume(e -&gt; {</span>
<span class="nc" id="L120">                                                    logger.error(&quot;Error fetching news for {}: {}&quot;, ticker, e.getMessage(), e);</span>
<span class="nc" id="L121">                                                    return Mono.empty();</span>
                                                });
                                    }
                                });
<span class="nc" id="L125">                    } catch (Exception e) {</span>
<span class="nc" id="L126">                        logger.error(&quot;Error processing stockQueryDto: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L127">                        return Mono.empty();</span>
                    }
                })
<span class="fc" id="L130">                .then();</span>
    }
    /**
     * Metoda pro získání ratingu pro dotazy na akcie.
     *
     * @param queries Seznam dotazů na akcie.
     * @return Mono obsahující seznam dotazů s nastaveným ratingem.
     */

    public Mono&lt;List&lt;StockQueryDto&gt;&gt; getRatingsForQueries(List&lt;StockQueryDto&gt; queries) {
<span class="fc" id="L140">        ZoneId zone = ZoneId.of(&quot;Europe/Prague&quot;);</span>

<span class="fc" id="L142">        List&lt;Mono&lt;StockQueryDto&gt;&gt; resultMonos = queries.stream().map(query -&gt; {</span>
<span class="fc" id="L143">            LocalDate date = Instant.ofEpochMilli(query.getDate())</span>
<span class="fc" id="L144">                    .atZone(zone)</span>
<span class="fc" id="L145">                    .toLocalDate();</span>

<span class="fc" id="L147">            LocalDateTime start = date.atStartOfDay();</span>
<span class="fc" id="L148">            LocalDateTime end = date.atTime(LocalTime.MAX);</span>

<span class="fc" id="L150">            return Mono.fromCallable(() -&gt; {</span>
<span class="fc" id="L151">                Optional&lt;StockSentiment&gt; sentimentOpt = stockSentimentRepository</span>
<span class="fc" id="L152">                        .findFirstByStockNameAndValidFromBetweenOrderByCreatedAtDesc(query.getName(), start, end);</span>

                // Pokud sentiment existuje, nastav rating
<span class="fc bfc" id="L155" title="All 2 branches covered.">                if (sentimentOpt.isPresent()) {</span>
<span class="fc" id="L156">                    query.setRating(sentimentOpt.get().getRating());</span>
                } else {
                    // Pokud není žádný záznam, rating nech jako 0
<span class="fc" id="L159">                    query.setRating(0);</span>
                }

<span class="fc" id="L162">                return query;</span>
            });
<span class="fc" id="L164">        }).toList();</span>

<span class="fc" id="L166">        return Flux.merge(resultMonos).collectList();</span>
    }




/*     * Pomocná metoda pro odečtení pracovních dnů od zadaného data.
     *
     * @param date        Počáteční datum.
     * @param businessDays Počet pracovních dnů k odečtení.
     * @return Nové datum po odečtení pracovních dnů.
     */
    private LocalDate subtractBusinessDays(LocalDate date, int businessDays) {
<span class="fc" id="L179">        LocalDate result = date;</span>
<span class="fc" id="L180">        int subtracted = 0;</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        while (subtracted &lt; businessDays) {</span>
<span class="nc" id="L182">            result = result.minusDays(1);</span>
<span class="nc" id="L183">            DayOfWeek day = result.getDayOfWeek();</span>
<span class="nc bnc" id="L184" title="All 4 branches missed.">            if (day != DayOfWeek.SATURDAY &amp;&amp; day != DayOfWeek.SUNDAY) {</span>
<span class="nc" id="L185">                subtracted++;</span>
            }
<span class="nc" id="L187">        }</span>
<span class="fc" id="L188">        return result;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>